% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/spec.R
\name{jgd-spec}
\alias{jgd-spec}
\alias{jgd-protocol}
\title{jgd NDJSON Protocol Specification}
\description{
The jgd device communicates with a rendering server over NDJSON
(newline-delimited JSON). Messages are exchanged over a persistent
connection using one of three transport protocols: Unix domain sockets
(Linux/macOS), Windows named pipes, or TCP.
}
\section{Transport protocols}{


The R client connects to the server using one of the following URI schemes:
\itemize{
\item \verb{unix:///path/to/socket} -- Unix domain socket (Linux/macOS default)
\item \verb{npipe:///pipe/name} -- Windows named pipe (Windows default)
\item \verb{tcp://host:port} -- TCP socket (any platform)
}

Raw Unix socket paths (without a URI scheme) are also accepted.
}

\section{Message format}{


All messages are single-line JSON objects terminated by \verb{\\n}. Each message
contains a \code{"type"} field identifying the message kind. The protocol is
symmetric: both R and the server send messages using the same framing.
}

\section{Connection handshake (server_info welcome)}{


After a connection is established, the server sends a \code{server_info} welcome
message to the R client. This welcome is \strong{deferred}: the server waits
until it receives the first message from R before sending it. This avoids
a race condition on Windows named pipes where writing before the first read
completes can cause data loss.

The R client triggers the welcome by sending a ping message immediately
after connecting:

\if{html}{\out{<div class="sourceCode">}}\preformatted{R -> Server:  \{"type":"ping"\}
Server -> R:  \{"type":"server_info","serverName":"jgd-http-server",
               "protocolVersion":1,"transport":"unix",
               "serverInfo":\{"httpUrl":"http://..."\}\}
}\if{html}{\out{</div>}}

The R client reads up to 3 lines with a 200 ms timeout per read to
account for potential message reordering. Non-\code{server_info} messages
received during handshake are silently discarded.

If the server does not send a welcome within the timeout, the device
operates normally without server metadata. \code{\link[=jgd_server_info]{jgd_server_info()}} returns
\code{NULL} in this case.
}

\section{server_info message format}{


The \code{server_info} message has the following structure:
\itemize{
\item \strong{\code{type}}: \code{"server_info"} (string, always present)
\item \strong{\code{serverName}}: Human-readable server name, e.g. \code{"jgd-http-server"}
(string)
\item \strong{\code{protocolVersion}}: Protocol version number, currently \code{1} (integer)
\item \strong{\code{transport}}: Transport protocol in use: \code{"tcp"}, \code{"unix"}, or
\code{"npipe"} (string)
\item \strong{\code{serverInfo}}: A flat JSON object whose values are all strings.
Provides additional server metadata:
\itemize{
\item \strong{\code{httpUrl}}: URL of the server's HTTP endpoint, e.g.
\code{"http://127.0.0.1:8080/"}
}
}

Example:

\if{html}{\out{<div class="sourceCode json">}}\preformatted{\{
  "type": "server_info",
  "serverName": "jgd-http-server",
  "protocolVersion": 1,
  "transport": "unix",
  "serverInfo": \{
    "httpUrl": "http://127.0.0.1:8080/"
  \}
\}
}\if{html}{\out{</div>}}
}

\section{R-side representation}{


\code{\link[=jgd_server_info]{jgd_server_info()}} returns a named list with four elements, or \code{NULL}
if no welcome was received:
\itemize{
\item \strong{\code{server_name}}: The server name (character scalar)
\item \strong{\code{protocol_version}}: The protocol version (integer scalar)
\item \strong{\code{transport}}: The transport protocol (character scalar)
\item \strong{\code{server_info}}: A named character vector of key-value pairs from the
\code{serverInfo} object (e.g. \code{c(httpUrl = "http://...")})
}

\code{jgd_server_info()} returns \code{NULL} when:
\itemize{
\item The current device is not a jgd device
\item The server did not send a welcome within the timeout
\item The device was not connected at open time
}
}

\section{R-to-server message types}{

\itemize{
\item \strong{\code{ping}}: Heartbeat; triggers the deferred welcome on first send.
\code{{"type":"ping"}}
\item \strong{\code{frame}}: A complete or incremental set of plot operations.
Contains a \code{plot} object with \code{sessionId}, \code{ops} (array of drawing
operations), and \code{device} (device dimensions in pixels/dpi).
The \code{incremental} flag distinguishes partial updates from full frames.
\item \strong{\code{metrics_request}}: Requests font metrics from the browser.
Contains \code{id} (integer), \code{kind} (\code{"strWidth"} or \code{"metricInfo"}),
and font/text parameters.
\item \strong{\code{close}}: Signals that \code{dev.off()} was called.
\code{{"type":"close"}}
}
}

\section{Server-to-R message types}{

\itemize{
\item \strong{\code{server_info}}: Welcome message (see above).
\item \strong{\code{resize}}: Browser viewport change.
\verb{\{"type":"resize","width":<px>,"height":<px>\}}
\item \strong{\code{metrics_response}}: Font metrics from the browser.
\verb{\{"type":"metrics_response","id":<int>,"width":<num>,"ascent":<num>, "descent":<num>\}}
}
}

\seealso{
\code{\link[=jgd]{jgd()}}, \code{\link[=jgd_server_info]{jgd_server_info()}}
}
